- name: Attach a VM to a dvswitch
  vcenter_vm_hardware_ethernet:
    state: create
    vm: '{{ test_vm1_info.value[0].vm }}'
    pci_slot_number: 4
    backing:
      type: DISTRIBUTED_PORTGROUP
      network: "{{ my_portgroup_info.dvs_portgroup_info.dvswitch1[0].key }}"
    start_connected: false
  register: _vm_hardware_ethernet_1

- name: _Attach a VM to a dvswitch (again)
  vcenter_vm_hardware_ethernet:
    state: create
    vm: '{{ test_vm1_info.value[0].vm }}'
    pci_slot_number: 4
    backing:
      type: DISTRIBUTED_PORTGROUP
      network: "{{ my_portgroup_info.dvs_portgroup_info.dvswitch1[0].key }}"
    start_connected: false
  register: _vm_hardware_ethernet_2

- name: Validate idempotency
  assert:
    that: _vm_hardware_ethernet_1.value._key == _vm_hardware_ethernet_2.value._key
- debug: var=_vm_hardware_ethernet_1

- name: Turn the NIC's start_connected flag on
  vcenter_vm_hardware_ethernet:
    state: update
    nic: 4000
    start_connected: true
    vm: '{{ test_vm1_info.value[0].vm }}'

- name: Collect a list of the NIC for a given VM
  vcenter_vm_hardware_ethernet_info:
    vm: '{{ test_vm1_info.value[0].vm }}'

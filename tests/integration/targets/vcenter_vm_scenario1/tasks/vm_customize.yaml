---
- name: Shut down the VM
  vmware.vmware_rest.vcenter_vm_guest_power:
    state: shutdown
    vm: '{{ test_vm1_info.id }}'

- name: Wait until my VM is off
  vmware.vmware_rest.vcenter_vm_info:
    vm: '{{ test_vm1_info.id }}'
  register: vm_info
  until:
  - vm_info is not failed
  - vm_info.value.power_state == "POWERED_OFF"
  retries: 60
  delay: 5

- name: Customize a VM
  vmware.vmware_rest.vcenter_vm_guest_customization:
    vm: "{{ lookup('vmware.vmware_rest.vm_moid', '/my_dc/vm/test_vm1') }}"
    configuration_spec:
      linux_config:
        domain: mydomain
        hostname:
          fixed_name: foobar
          type: FIXED
    interfaces:
      - adapter:
          ipv4:
            type: STATIC
            gateways:
              - 10.13.45.3
            ip_address: 10.13.45.5
            prefix: 24
    global_DNS_settings:
      dns_suffix_list: []
      dns_servers:
        - 1.1.1.1

- name: _Turn the power of the VM on with the customization
  vmware.vmware_rest.vcenter_vm_power:
    state: start
    vm: '{{ test_vm1_info.id }}'
